(function(){function n(e){return"function"==typeof e}function p(e){if(!e)return!1;var d,g;return"object"!=(g=typeof e)&&"function"!=g?!1:n(d=e.then)?d:!1}function q(e){return"object"==typeof e&&3===v(e)&&!e.nodeType&&e.constructor===Object}function u(e){return!0===e||!1===e}var l=Function.prototype.bind?function(e,d){return e.bind(d)}:function(e,d){return function(){return e.apply(d,arguments)}},r=function(){var e=[],d=function(g){var d;var h=0;for(d=e.length;h<d;h++)if(!1===e[h][0].call(e[h][1],
g))return;h=(g?g.stack:null)||Error().stack;if("undefined"!=typeof console&&console.error)g&&console.error(g),h&&console.error(h);else throw g;};d.on=function(g,l){d.un(g,l);e.push([g,l])};d.un=function(g,d){var h;var k=0;for(h=e.length;k<h;k++)if(e[k][0]===g&&e[k][1]===d){e.splice(k,1);break}};return d}(),w=Array.prototype.slice,x=Object.prototype.toString,v=function(){var e={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,
"[object RegExp]":9,"[object Date]":10};return function(d){if(!d){if(null===d)return 6;if(void 0===d)return 7}var g=e[x.call(d)];return void 0===g?-1:1===g&&isNaN(d)?8:g}}(),y=function(){return function d(){var g=!1,l=!1,h=w.call(arguments),k=h.shift(),f,a,b;u(h[h.length-1])&&(g=h.pop());u(h[h.length-1])&&(l=g,g=h.pop());for(;h.length;)if((f=h.shift())&&f.hasOwnProperty)for(a in f)if(f.hasOwnProperty(a)&&void 0!==(b=f[a]))if(l)if(k[a]&&q(k[a])&&q(b))d(k[a],b,g,l);else{if(!0===g||void 0==k[a])q(b)?
(k[a]={},d(k[a],b,g,!0)):k[a]=b}else if(!0===g||void 0==k[a])k[a]=b;return k}}(),A=function(){var e=[],d=!1,g="undefined"!==typeof process?process.nextTick:function(a){setTimeout(a,0)},q=function(){d=!0;var a=e.shift();g(function(){a[0].apply(a[1],a[2]);e.length?q():d=!1},0)},h=function(a,b,c){c=c||[];e.push([a,b,c]);d||q()},k=function(a,b){return function(c){try{b.resolve(a(c))}catch(m){b.reject(m)}}},f=function(a,b){if(a instanceof f)return a;if(!(this instanceof f))return new f(a,b);var c;this._fulfills=
[];this._rejects=[];this._dones=[];this._fails=[];if(0<arguments.length)if(c=p(a))a instanceof f?a.then(l(this.resolve,this),l(this.reject,this)):(new f(c,a)).then(l(this.resolve,this),l(this.reject,this));else if(n(a))try{a.call(b,l(this.resolve,this),l(this.reject,this))}catch(m){this.reject(m)}else this.resolve(a)};y(f.prototype,{_state:0,_fulfills:null,_rejects:null,_dones:null,_fails:null,_wait:0,_value:null,_reason:null,_triggered:!1,isPending:function(){return 0===this._state},isFulfilled:function(){return 1===
this._state},isResolved:function(){return 1===this._state},isRejected:function(){return 2===this._state},hasListeners:function(){var a=[this._fulfills,this._rejects,this._dones,this._fails],b;var c=0;for(b=a.length;c<b;c++)if(a[c]&&a[c].length)return!0;return!1},_cleanup:function(){this._fails=this._dones=this._rejects=this._fulfills=null},_processValue:function(a,b,c){var m;if(0===this._state)if(a===this)this._doReject(new TypeError("cannot resolve promise with itself"));else{if(c)try{if(m=p(a)){a instanceof
f?a.then(l(this._processResolveValue,this),l(this._processRejectReason,this)):(new f(m,a)).then(l(this._processResolveValue,this),l(this._processRejectReason,this));return}}catch(z){0===this._state&&this._doReject(z);return}b.call(this,a)}},_callResolveHandlers:function(){this._done();for(var a=this._fulfills,b;b=a.shift();)h(b[0],b[1],[this._value]);this._cleanup()},_doResolve:function(a){this._value=a;this._state=1;0===this._wait&&this._callResolveHandlers()},_processResolveValue:function(a){this._processValue(a,
this._doResolve,!0)},resolve:function(a){if(this._triggered)return this;this._triggered=!0;this._processResolveValue(a);return this},_callRejectHandlers:function(){this._fail();for(var a=this._rejects,b;b=a.shift();)h(b[0],b[1],[this._reason]);this._cleanup()},_doReject:function(a){this._state=2;this._reason=a;0===this._wait&&this._callRejectHandlers()},_processRejectReason:function(a){this._processValue(a,this._doReject,!1)},reject:function(a){if(this._triggered)return this;this._triggered=!0;this._processRejectReason(a);
return this},then:function(a,b,c){var m=new f,e=this._state;c&&(a&&(a=l(a,c)),b&&(b=l(b,c)));0===e||0!==this._wait?(a&&n(a)?this._fulfills.push([k(a,m),null]):this._fulfills.push([m.resolve,m]),b&&n(b)?this._rejects.push([k(b,m),null]):this._rejects.push([m.reject,m])):1===e?a&&n(a)?h(k(a,m),null,[this._value]):m.resolve(this._value):2===e&&(b&&n(b)?h(k(b,m),null,[this._reason]):m.reject(this._reason));return m},"catch":function(a){return this.then(null,a)},_done:function(){for(var a=this._dones,
b;b=a.shift();)try{b[0].call(b[1]||null,this._value)}catch(c){r(c)}},done:function(a,b){var c=this._state;if(1===c&&0===this._wait)try{a.call(b||null,this._value)}catch(m){r(m)}else 0===c&&this._dones.push([a,b]);return this},_fail:function(){for(var a=this._fails,b;b=a.shift();)try{b[0].call(b[1]||null,this._reason)}catch(c){r(c)}},fail:function(a,b){var c=this._state;if(2===c&&0===this._wait)try{a.call(b||null,this._reason)}catch(m){r(m)}else 0===c&&this._fails.push([a,b]);return this},always:function(a,
b){this.done(a,b);this.fail(a,b);return this},promise:function(){return{then:l(this.then,this),done:l(this.done,this),fail:l(this.fail,this),always:l(this.always,this),"catch":l(this["catch"],this)}},after:function(a){var b=this;if(p(a)){b._wait++;var c=function(){b._wait--;0===b._wait&&0!==b._state&&(1===b._state?b._callResolveHandlers():b._callRejectHandlers())};n(a.done)?a.done(c):a.then(c)}return b}},!0,!1);f.fcall=function(a,b,c){return f.resolve(a.apply(b,c||[]))};f.resolve=function(a){var b=
new f;b.resolve(a);return b};f.reject=function(a){var b=new f;b.reject(a);return b};f.all=function(a){if(!a.length)return f.resolve(null);var b=new f,c=a.length,m=Array(c),e=c,d,g,h=function(a,c){m[c]=a;e--;0===e&&b.resolve(m)};for(d=0;d<c;d++)(function(c){g=a[d];g instanceof f?g.done(function(a){h(a,c)}).fail(b.reject,b):p(g)||n(g)?(new f(g)).done(function(a){h(a,c)}).fail(b.reject,b):h(g,c)})(d);return b};f.when=function(){return f.all(arguments)};f.allResolved=function(a){if(!a.length)return f.resolve(null);
var b=new f,c=a.length,e=[],g=c,d,h=function(a){e.push(a);l()},l=function(){g--;0===g&&b.resolve(e)};for(d=0;d<c;d++){var k=a[d];k instanceof f?k.done(h).fail(l):p(k)||n(k)?(new f(k)).done(h).fail(l):h(k)}return b};f.race=function(a){if(!a.length)return f.resolve(null);var b=new f,c=a.length,e;for(e=0;e<c;e++){var d=a[e];d instanceof f?d.done(b.resolve,b).fail(b.reject,b):p(d)||n(d)?(new f(d)).done(b.resolve,b).fail(b.reject,b):b.resolve(d);if(!b.isPending())break}return b};f.waterfall=function(a){if(!a.length)return f.resolve(null);
var b=a.shift();b=n(b)?f.fcall(b):f.resolve(c);for(var c;c=a.shift();)p(c)?b=b.then(function(a){return function(){return a}}(c)):n(c)?b=b.then(c):b.resolve(c);return b};f.forEach=function(a,b,c,e){var d=a.slice(),g=new f,h=[],l=0,k=function(){if(d.length){var a=d.shift(),m=l;l++;f.fcall(b,c,[a,m]).done(function(a){h.push(a);k()}).fail(function(a){e?g.reject(a):(h.push(null),k())})}else g.resolve(h)};k();return g};f.counter=function(a){var b=new f;b.countdown=function(){a--;0===a&&b.resolve()};return b};
return f}(),t={};t.Promise=A;"undefined"!=typeof global?global.MetaphorJs=t:window.MetaphorJs=t})();
