define("metaphorjs-promise",function(){function h(d){return"function"==typeof d}function m(d){if(!d)return!1;var g;if("object"!=(g=typeof d)&&"function"!=g)return!1;d=d.then;return h(d)?d:!1}function u(d){return"object"==typeof d&&3===y(d)&&!d.nodeType&&d.constructor===Object}function x(d){return!0===d||!1===d}function v(){var d=!1,g=!1,e;if((e=arguments)&&void 0!=!e.length&&e!==""+e){for(var f=[],l=-1,h=e.length>>>0;++l!==h;f[l]=e[l]);e=f}else e=e?[e]:[];f=e.shift();var c,a;x(e[e.length-1])&&(d=
e.pop());x(e[e.length-1])&&(g=d,d=e.pop());for(;e.length;)if(l=e.shift())for(c in l)if(l.hasOwnProperty(c)&&void 0!==(a=l[c]))if(g)if(f[c]&&u(f[c])&&u(a))v(f[c],a,d,g);else{if(!0===d||void 0==f[c])u(a)?(f[c]={},v(f[c],a,d,!0)):f[c]=a}else if(!0===d||void 0==f[c])f[c]=a;return f}var t=function(){var d=[],g=function(e){var f;var g=0;for(f=d.length;g<f;g++)d[g][0].call(d[g][1],e);"undefined"!=typeof console&&console.error&&console.error(e)};g.on=function(e,f){g.un(e,f);d.push([e,f])};g.un=function(e,
g){var f;var h=0;for(f=d.length;h<f;h++)if(d[h][0]===e&&d[h][1]===g){d.splice(h,1);break}};return g}(),z=Object.prototype.toString,y=function(){var d={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(g){if(!g){if(null===g)return 6;if(void 0===g)return 7}var e=d[z.call(g)];return void 0===e?-1:1===e&&isNaN(g)?8:e}}();return function(){var d=[],g=!1,e="undefined"!==typeof process?
process.nextTick:function(a){setTimeout(a,0)},f=function(){g=!0;var a=d.shift();e(function(){a[0].apply(a[1],a[2]);d.length?f():g=!1},0)},l=function(a,b,c){c=c||[];d.push([a,b,c]);g||f()},r=function(a,b){return function(c){try{b.resolve(a(c))}catch(n){b.reject(n)}}},c=function(a,b){if(a instanceof c)return a;if(!(this instanceof c))return new c(a,b);var k;this._fulfills=[];this._rejects=[];this._dones=[];this._fails=[];if(0<arguments.length)if(k=m(a))a instanceof c?a.then(this.resolve.bind(this),
this.reject.bind(this)):(new c(k,a)).then(this.resolve.bind(this),this.reject.bind(this));else if(h(a))try{a.call(b,this.resolve.bind(this),this.reject.bind(this))}catch(n){this.reject(n)}else this.resolve(a)};v(c.prototype,{_state:0,_fulfills:null,_rejects:null,_dones:null,_fails:null,_wait:0,_value:null,_reason:null,_triggered:!1,isPending:function(){return 0===this._state},isFulfilled:function(){return 1===this._state},isResolved:function(){return 1===this._state},isRejected:function(){return 2===
this._state},isCancelled:function(){return 3===this._state},hasListeners:function(){var a=[this._fulfills,this._rejects,this._dones,this._fails],b;var c=0;for(b=a.length;c<b;c++)if(a[c]&&a[c].length)return!0;return!1},_cleanup:function(){this._fails=this._dones=this._rejects=this._fulfills=null},_processValue:function(a,b,k){var d;if(0===this._state)if(a===this)this._doReject(new TypeError("cannot resolve promise with itself"));else{if(k)try{if(d=m(a)){a instanceof c?a.then(this._processResolveValue.bind(this),
this._processRejectReason.bind(this)):(new c(d,a)).then(this._processResolveValue.bind(this),this._processRejectReason.bind(this));return}}catch(A){0===this._state&&this._doReject(A);return}b.call(this,a)}},_callResolveHandlers:function(){this._done();for(var a=this._fulfills,b;b=a.shift();)l(b[0],b[1],[this._value]);this._cleanup()},_doResolve:function(a){this._value=a;this._state=1;0===this._wait&&this._callResolveHandlers()},_processResolveValue:function(a){this._processValue(a,this._doResolve,
!0)},resolve:function(a){if(this._triggered)return this;this._triggered=!0;this._processResolveValue(a);return this},_callRejectHandlers:function(){this._fail();for(var a=this._rejects,b;b=a.shift();)l(b[0],b[1],[this._reason]);this._cleanup()},_doReject:function(a){this._state=2;this._reason=a;0===this._wait&&this._callRejectHandlers()},_processRejectReason:function(a){this._processValue(a,this._doReject,!1)},reject:function(a){if(this._triggered)return this;this._triggered=!0;this._processRejectReason(a);
return this},then:function(a,b,d){var k=new c,e=this._state;d&&(a&&(a=a.bind(d)),b&&(b=b.bind(d)));0===e||0!==this._wait?(a&&h(a)?this._fulfills.push([r(a,k),null]):this._fulfills.push([k.resolve,k]),b&&h(b)?this._rejects.push([r(b,k),null]):this._rejects.push([k.reject,k])):1===e?a&&h(a)?l(r(a,k),null,[this._value]):k.resolve(this._value):2===e&&(b&&h(b)?l(r(b,k),null,[this._reason]):k.reject(this._reason));return k},"catch":function(a){return this.then(null,a)},_done:function(){for(var a=this._dones,
b;b=a.shift();)try{b[0].call(b[1]||null,this._value)}catch(k){t(k)}},done:function(a,b){var c=this._state;if(1===c&&0===this._wait)try{a.call(b||null,this._value)}catch(n){t(n)}else 0===c&&this._dones.push([a,b]);return this},_fail:function(){for(var a=this._fails,b;b=a.shift();)try{b[0].call(b[1]||null,this._reason)}catch(k){t(k)}},fail:function(a,b){var c=this._state;if(2===c&&0===this._wait)try{a.call(b||null,this._reason)}catch(n){t(n)}else 0===c&&this._fails.push([a,b]);return this},always:function(a,
b){this.done(a,b);this.fail(a,b);return this},promise:function(){return{then:this.then.bind(this),done:this.done.bind(this),fail:this.fail.bind(this),always:this.always.bind(this),"catch":this["catch"].bind(this)}},after:function(a){var b=this;if(m(a)){b._wait++;var c=function(){b._wait--;0===b._wait&&0!==b._state&&(1===b._state?b._callResolveHandlers():b._callRejectHandlers())};h(a.done)?a.done(c):a.then(c)}return b},$destroy:function(){this._cleanup();0===this._state&&(this._state=3)}},!0,!1);c.fcall=
function(a,b,d){return c.resolve(a.apply(b,d||[]))};c.resolve=function(a){var b=new c;b.resolve(a);return b};c.reject=function(a){var b=new c;b.reject(a);return b};c.all=function(a){if(!a.length)return c.resolve(null);var b=new c,d=a.length,e=Array(d),g=d,f,p,l=function(a,c){e[c]=a;g--;0===g&&b.resolve(e)};for(f=0;f<d;f++)(function(d){p=a[f];p instanceof c?p.done(function(a){l(a,d)}).fail(b.reject,b):m(p)||h(p)?(new c(p)).done(function(a){l(a,d)}).fail(b.reject,b):l(p,d)})(f);return b};c.when=function(){return c.all(arguments)};
c.allResolved=function(a){if(!a.length)return c.resolve(null);var b=new c,d=a.length,e=[],g=d,f,l=function(a){e.push(a);w()},w=function(){g--;0===g&&b.resolve(e)};for(f=0;f<d;f++){var q=a[f];q instanceof c?q.done(l).fail(w):m(q)||h(q)?(new c(q)).done(l).fail(w):l(q)}return b};c.race=function(a){if(!a.length)return c.resolve(null);var b=new c,d=a.length,e;for(e=0;e<d;e++){var f=a[e];f instanceof c?f.done(b.resolve,b).fail(b.reject,b):m(f)||h(f)?(new c(f)).done(b.resolve,b).fail(b.reject,b):b.resolve(f);
if(!b.isPending())break}return b};c.waterfall=function(a){if(!a.length)return c.resolve(null);var b=a.shift();b=h(b)?c.fcall(b):c.resolve(d);for(var d;d=a.shift();)m(d)?b=b.then(function(a){return function(){return a}}(d)):h(d)?b=b.then(d):b.resolve(d);return b};c.forEach=function(a,b,d,e){var f=a.slice(),g=new c,h=[],l=0,k=function(){if(f.length){var a=f.shift(),m=l;l++;c.fcall(b,d,[a,m]).done(function(a){h.push(a);k()}).fail(function(a){e?g.reject(a):(h.push(null),k())})}else g.resolve(h)};k();
return g};c.counter=function(a){var b=new c;b.countdown=function(){a--;0===a&&b.resolve()};return b};return c}()});
